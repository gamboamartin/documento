<?php
namespace models;
use base\orm\modelo;
use gamboamartin\errores\errores;


use PDO;
use stdClass;

class seccion extends modelo{
    /**
     * DEBUG INI
     * seccion_menu constructor.
     * @param PDO $link
     */
    public function __construct(PDO $link){
        $tabla = __CLASS__;
        $columnas = array($tabla=>false, 'menu'=>$tabla);
        $campos_obligatorios = array('status','descripcion','menu_id');
        parent::__construct(link: $link,tabla:  $tabla,campos_obligatorios: $campos_obligatorios,columnas:  $columnas);
    }

    /**
     * @return array|stdClass
     */
    public function alta_bd(): array|stdClass
    {
        $r_alta_bd = parent::alta_bd(); // TODO: Change the autogenerated stub
        if(errores::$error){
            return $this->error->error(mensaje: 'Error al dar de alta seccion',data: $r_alta_bd, params: get_defined_vars());
        }

        $data = $this->obten_columnas($this->registro['descripcion']);
        if(errores::$error){
            return $this->error->error(mensaje: 'Error al obtener columnas',data: $data, params: get_defined_vars());
        }

        $columnas = $data->columnas_parseadas;

        $omite = array('id','usuario_alta_id','usuario_update_id','fecha_alta','fecha_update');


        $texts[] = 'adjunto';
        $texts[] = 'adjunto_alto';
        $texts[] = 'adjunto_ancho';
        $texts[] = 'alias';
        $texts[] = 'antiguedad_empleado';
        $texts[] = 'ap_pat';
        $texts[] = 'ap_mat';
        $texts[] = 'aplica_iva';
        $texts[] = 'asunto';
        $texts[] = 'calle';
        $texts[] = 'calle_telc';
        $texts[] = 'calle_2';
        $texts[] = 'cantidad';
        $texts[] = 'certificado';
        $texts[] = 'chat_id';
        $texts[] = 'ciudad';
        $texts[] = 'ciudad_telc';
        $texts[] = 'clave';
        $texts[] = 'codigo';
        $texts[] = 'cod_post';
        $texts[] = 'colonia';
        $texts[] = 'col_telc';
        $texts[] = 'col_2';
        $texts[] = 'comando';
        $texts[] = 'con_copia';
        $texts[] = 'controlador';
        $texts[] = 'correo';
        $texts[] = 'correo_receptor';
        $texts[] = 'correos';
        $texts[] = 'costo_avaluo';
        $texts[] = 'credito_vigente';
        $texts[] = 'cp';
        $texts[] = 'cp_telcl';
        $texts[] = 'contenido';
        $texts[] = 'cuenta';
        $texts[] = 'cuota_fija';
        $texts[] = 'curp';
        $texts[] = 'curp_ine';
        $texts[] = 'cve_elec';
        $texts[] = 'date';
        $texts[] = 'deduccion_total_otras_deducciones';
        $texts[] = 'descripcion';
        $texts[] = 'descuento';
        $texts[] = 'descuento_bruto';
        $texts[] = 'descuento_compartido';
        $texts[] = 'descuento_neto';
        $texts[] = 'destino';
        $texts[] = 'direccion';
        $texts[] = 'domicilio';
        $texts[] = 'dom_pat';
        $texts[] = 'edo_telc';
        $texts[] = 'email';
        $texts[] = 'enviado';
        $texts[] = 'es_folder';
        $texts[] = 'estado_llamada_id';
        $texts[] = 'estilo';
        $texts[] = 'es_variable';
        $texts[] = 'exento';
        $texts[] = 'existe_registro';
        $texts[] = 'ext_telc';
        $texts[] = 'fecha_agenda';
        $texts[] = 'fecha_generacion';
        $texts[] = 'fecha_llamada';
        $texts[] = 'fecha_nacimiento';
        $texts[] = 'fecha_zip';
        $texts[] = 'first_name_chat';
        $texts[] = 'first_name_from';
        $texts[] = 'folio';
        $texts[] = 'from_id';
        $texts[] = 'generado';
        $texts[] = 'giro';
        $texts[] = 'gps';
        $texts[] = 'gps_altitude';
        $texts[] = 'gps_latitude';
        $texts[] = 'gps_latitude_ref';
        $texts[] = 'gps_longitude';
        $texts[] = 'gps_longitude_ref';
        $texts[] = 'gravable';
        $texts[] = 'host';
        $texts[] = 'id_drive';
        $texts[] = 'id_mailbox';
        $texts[] = 'importe';
        $texts[] = 'inicial';
        $texts[] = 'intentos';
        $texts[] = 'int_telc';
        $texts[] = 'iva';
        $texts[] = 'language_code';
        $texts[] = 'llamada';
        $texts[] = 'liga';
        $texts[] = 'limite_inferior';
        $texts[] = 'limite_superior';
        $texts[] = 'loc_pat';
        $texts[] = 'name_doc';
        $texts[] = 'mensaje';
        $texts[] = 'message_id';
        $texts[] = 'monto';
        $texts[] = 'monto_descuento_fijo';
        $texts[] = 'monto_pagado';
        $texts[] = 'monto_pago';
        $texts[] = 'monto_pago_bruto';
        $texts[] = 'monto_pago_neto';
        $texts[] = 'monto_precalificacion';
        $texts[] = 'monto_previsto';
        $texts[] = 'monto_retenido';
        $texts[] = 'monto_solicitado';
        $texts[] = 'monto_subcuenta_vivienda';
        $texts[] = 'monto_vale_ecotecnologias';
        $texts[] = 'muestra_proceso_firma';
        $texts[] = 'mun_2';
        $texts[] = 'n_dias_pago';
        $texts[] = 'n_registros';
        $texts[] = 'n_registros_fin';
        $texts[] = 'n_registros_ini';
        $texts[] = 'n_registros_global';
        $texts[] = 'no_certificado';
        $texts[] = 'no_certificado_sat';
        $texts[] = 'nombre';
        $texts[] = 'nombres';
        $texts[] = 'nombre_arrendatario';
        $texts[] = 'nombre_notario';
        $texts[] = 'nom_pat';
        $texts[] = 'numero_exterior';
        $texts[] = 'numero_interior';
        $texts[] = 'numero_notaria';
        $texts[] = 'num_seg_so';
        $texts[] = 'obligatorio';
        $texts[] = 'observaciones';
        $texts[] = 'password';
        $texts[] = 'percepcion_total_exento';
        $texts[] = 'percepcion_total_gravado';
        $texts[] = 'percepcion_total_sueldo';
        $texts[] = 'porcentaje_exedente';
        $texts[] = 'porcentaje_excedente';
        $texts[] = 'porcentaje_retencion';
        $texts[] = 'prioridad';
        $texts[] = 'puerto';
        $texts[] = 'recibido';
        $texts[] = 'ref_1';
        $texts[] = 'ref_2';
        $texts[] = 'registro_patronal';
        $texts[] = 'reg_patron';
        $texts[] = 'rfc';
        $texts[] = 'rfc_2';
        $texts[] = 'rfc_proveedor';
        $texts[] = 'ruta';
        $texts[] = 'ruta_absoluta';
        $texts[] = 'ruta_dbx';
        $texts[] = 'ruta_drive';
        $texts[] = 'ruta_mini';
        $texts[] = 'ruta_relativa';
        $texts[] = 'sal_base';
        $texts[] = 'sd';
        $texts[] = 'sdi';
        $texts[] = 'segundos_retardo';
        $texts[] = 'sello';
        $texts[] = 'sello_cfd';
        $texts[] = 'sello_sat';
        $texts[] = 'serie';
        $texts[] = 'size';
        $texts[] = 'status_envio';
        $texts[] = 'sub_total';
        $texts[] = 'telefono';
        $texts[] = 'tel_cel';
        $texts[] = 'tel_contac_telc';
        $texts[] = 'tel_1';
        $texts[] = 'tel_2';
        $texts[] = 'tel_3';
        $texts[] = 'text';
        $texts[] = 'tfd_schema_location';
        $texts[] = 'tfd_version';
        $texts[] = 'tfd_xmlns_tfd';
        $texts[] = 'tfd_xmlns_xsi';
        $texts[] = 'tiempo_fin_session';
        $texts[] = 'timbrado';
        $texts[] = 'total';
        $texts[] = 'total_deducciones';
        $texts[] = 'total_otros_pagos';
        $texts[] = 'total_percepciones';
        $texts[] = 'type';
        $texts[] = 'update_id';
        $texts[] = 'usuario';
        $texts[] = 'uuid';
        $texts[] = 'valida_cambio_estado';
        $texts[] = 'valor';
        $texts[] = 'valor_avaluo';
        $texts[] = 'valor_default';
        $texts[] = 'valor_unitario';
        $texts[] = 'value';
        $texts[] = 'version';
        $texts[] = 'xmlns_cfdi';
        $texts[] = 'xmlns_xsi';
        $texts[] = 'xsi_schema_location';
        $texts[] = 'zip_generado';


        $selects[] = 'accion_id';
        $selects[] = 'acl_valida_comision_id';
        $selects[] = 'almacen_id';
        $selects[] = 'asentamiento_id';
        $selects[] = 'atributo_id';
        $selects[] = 'avance_ubicacion_id';
        $selects[] = 'banco_id';
        $selects[] = 'base_prospecto_id';
        $selects[] = 'bono_id';
        $selects[] = 'campo_id';
        $selects[] = 'cerrador_id';
        $selects[] = 'chat_bot_id';
        $selects[] = 'cliente_id';
        $selects[] = 'cliente_etapa_id';
        $selects[] = 'comision_id';
        $selects[] = 'conf_comision_comercial_id';
        $selects[] = 'conf_deduccion_id';
        $selects[] = 'conf_gasto_ubicacion_id';
        $selects[] = 'configuracion_bono_id';
        $selects[] = 'configuracion_comision_id';
        $selects[] = 'contrato_id';
        $selects[] = 'colonia_id';
        $selects[] = 'cp_id';
        $selects[] = 'cp_patron_id';
        $selects[] = 'descuento_comision_id';
        $selects[] = 'deduccion_raya_id';
        $selects[] = 'departamento_id';
        $selects[] = 'detalle_solicitud_id';
        $selects[] = 'documento_id';
        $selects[] = 'documento_prospecto_id';
        $selects[] = 'documento_prospecto_ubicacion_id';
        $selects[] = 'drive_ruta_id';
        $selects[] = 'emisor_id';
        $selects[] = 'empleado_id';
        $selects[] = 'entrada_id';
        $selects[] = 'entrega_id';
        $selects[] = 'escriturador_id';
        $selects[] = 'esquema_comercial_id';
        $selects[] = 'esquema_comision_id';
        $selects[] = 'esquema_venta_id';
        $selects[] = 'estado_cheque_id';
        $selects[] = 'estado_comision_id';
        $selects[] = 'estado_deduccion_id';
        $selects[] = 'estado_entrega_id';
        $selects[] = 'estado_gasto_id';
        $selects[] = 'estado_prospecto_id';
        $selects[] = 'estado_solicitud_id';
        $selects[] = 'estado_ubicacion_id';
        $selects[] = 'estado_vivienda_id';
        $selects[] = 'extension_id';
        $selects[] = 'factura_id';
        $selects[] = 'factura_rel_id';
        $selects[] = 'forma_pago_id';
        $selects[] = 'funcion_id';
        $selects[] = 'gasto_definido_admin_id';
        $selects[] = 'grupo_id';
        $selects[] = 'grupo_comercial_id';
        $selects[] = 'indicador_id';
        $selects[] = 'metodo_pago_id';
        $selects[] = 'modelo';
        $selects[] = 'moneda_id';
        $selects[] = 'motivo_cancelacion_id';
        $selects[] = 'municipio_id';
        $selects[] = 'nombre_calle_id';
        $selects[] = 'notaria_firma_cotejo_id';
        $selects[] = 'notaria_id';
        $selects[] = 'nomina_id';
        $selects[] = 'pago_descuento_id';
        $selects[] = 'paquete_val_ubi_id';
        $selects[] = 'periodo_pago_id';
        $selects[] = 'producto_id';
        $selects[] = 'prospecto_id';
        $selects[] = 'prospecto_ubicacion_id';
        $selects[] = 'proveedor_id';
        $selects[] = 'puesto_id';
        $selects[] = 'qr_ubicacion_id';
        $selects[] = 'rango_bono_id';
        $selects[] = 'receptor_id';
        $selects[] = 'regimen_fiscal_id';
        $selects[] = 'renta_id';
        $selects[] = 'responsable_compra_id';
        $selects[] = 'sat_cfdi_id';
        $selects[] = 'sat_nomina_deduccion_id';
        $selects[] = 'sat_nomina_otro_pago_id';
        $selects[] = 'sat_nomina_percepcion_id';
        $selects[] = 'sat_nomina_periodicidad_pago_id';
        $selects[] = 'sat_nomina_periodo_pago_id';
        $selects[] = 'sat_nomina_riesgo_puesto_id';
        $selects[] = 'sat_nomina_tipo_contrato_id';
        $selects[] = 'sat_nomina_tipo_jornada_id';
        $selects[] = 'sat_nomina_tipo_nomina_id';
        $selects[] = 'sat_nomina_tipo_regimen_id';
        $selects[] = 'sat_producto_id';
        $selects[] = 'sat_receptor_id';
        $selects[] = 'sat_tipo_de_comprobante_id';
        $selects[] = 'seccion_menu_id';
        $selects[] = 'server_id';
        $selects[] = 'solicitud_gasto_id';
        $selects[] = 'status_cliente_id';
        $selects[] = 'status_ubicacion_id';
        $selects[] = 'tipo_ajuste_id';
        $selects[] = 'tipo_clave_oficina_id';
        $selects[] = 'tipo_comision_id';
        $selects[] = 'tipo_dato_id';
        $selects[] = 'tipo_descuento_id';
        $selects[] = 'tipo_documento_id';
        $selects[] = 'tipo_insumo_id';
        $selects[] = 'tipo_llamada_id';
        $selects[] = 'tipo_nomina_id';
        $selects[] = 'tipo_proveedor_id';
        $selects[] = 'tipo_relacion_id';
        $selects[] = 'tipo_vialidad_id';
        $selects[] = 'ubicacion_id';
        $selects[] = 'unidad_id';
        $selects[] = 'uso_cfdi_id';
        $selects[] = 'usuario_id';
        $selects[] = 'validation_id';
        $selects[] = 'valuador_id';
        $selects[] = 'zona_id';

        $fechas[] = 'fecha';
        $fechas[] = 'fecha_asignacion';
        $fechas[] = 'fecha_creacion';
        $fechas[] = 'fecha_emision';
        $fechas[] = 'fecha_envio';
        $fechas[] = 'fecha_fin';
        $fechas[] = 'fecha_final';
        $fechas[] = 'fecha_inicial';
        $fechas[] = 'fecha_inicio';
        $fechas[] = 'fecha_inicio_rel_laboral';
        $fechas[] = 'fecha_pago';
        $fechas[] = 'fecha_solicitud';
        $fechas[] = 'fecha_timbrado';


        foreach($texts as $text){
            $con_label[] = $text;
        }

        foreach($fechas as $fecha){
            $con_label[] = $fecha;
        }


        foreach($texts as $text){
            $requerido[] = $text;
        }
        foreach($fechas as $fecha){
            $requerido[] = $fecha;
        }


        $ln = array('calculado','default','entregada','validado','status','grava_isr','inicial','rentada','timbrado',
            'timbra');

        foreach($texts as $text){
            $filtro[] = $text;
        }


        foreach($texts as $text){
            $lista[] = $text;
        }

        foreach($selects as $select){
            $columnas_select[$select] = $select.'_id';
        }
        foreach($selects as $select){
            $data_etiquetas[] = $select;
        }


        $etiquetas = array();
        foreach($data_etiquetas as $etiqueta){
            $dato_etiqueta = str_replace('_id','',$etiqueta);
            $dato_etiqueta = str_replace('_',' ',$dato_etiqueta);
            $dato_etiqueta = ucfirst($dato_etiqueta);
            $etiquetas[$etiqueta] = $dato_etiqueta;

        }


        foreach($selects as $select){
            $campos_tabla_externa[$select] = 'id';
            $externa = str_replace('_id','',$select);
            $externas[$select] = $externa;
            $con_label[] = $select;
            $requerido[] = $select;
        }
        $ordenes['default'] = 1;
        $ordenes['fecha_creacion'] = 1;
        $ordenes['fecha_emision'] = 1;
        $ordenes['fecha_envio'] = 1;
        $ordenes['fecha_inicial'] = 2;
        $ordenes['fecha_final'] = 3;
        $ordenes['calculado'] = 4;
        $ordenes['entregada'] = 4;
        $ordenes['validado'] = 5;
        $ordenes['pagado'] = 6;
        $ordenes['gps'] = 7;
        $ordenes['gps_altitude'] = 7;
        $ordenes['gps_latitude'] = 7;
        $ordenes['gps_latitude_ref'] = 7;
        $ordenes['gps_longitude'] = 7;
        $ordenes['gps_longitude_ref'] = 7;
        $ordenes['grava_isr'] = 7;
        $ordenes['liga'] = 1000;
        $ordenes['status'] = 1000;
        $ordenes['fecha'] = 8;
        $ordenes['fecha_timbrado'] = 9;
        $ordenes['timbrado'] = 10;
        $ordenes['fecha_inicio'] = 11;
        $ordenes['fecha_fin'] = 12;
        $ordenes['fecha_pago'] = 13;
        $ordenes['fecha_inicio_rel_laboral'] = 14;
        $ordenes['fecha_asignacion'] = 15;
        $ordenes['fecha_solicitud'] = 15;


        $i = 15;
        foreach ($texts as $text){
            $ordenes[$text] = $i;
            $i++;
        }

        foreach ($selects as $select){
            $ordenes[$select] = $i;
            $i++;
        }


        foreach ($selects as $select){
            $tipo_campos[$select] = 'select_columnas';
        }


        $tipo_campos['fecha_asignacion'] = 'fecha';
        $tipo_campos['fecha_avaluo'] = 'fecha';
        $tipo_campos['fecha_creacion'] = 'fecha';
        $tipo_campos['fecha_emision'] = 'fecha';
        $tipo_campos['fecha_envio'] = 'fecha';
        $tipo_campos['fecha_inicial'] = 'fecha';
        $tipo_campos['fecha_inicio'] = 'fecha';
        $tipo_campos['fecha_pago'] = 'fecha';
        $tipo_campos['fecha_fin'] = 'fecha';
        $tipo_campos['fecha'] = 'fecha';
        $tipo_campos['fecha_final'] = 'fecha';
        $tipo_campos['fecha_timbrado'] = 'fecha';
        $tipo_campos['fecha_inicio_rel_laboral'] = 'fecha';
        $tipo_campos['fecha_solicitud'] = 'fecha';

        $tipo_campos['default'] = 'checkbox';
        $tipo_campos['status'] = 'checkbox';
        $tipo_campos['calculado'] = 'checkbox';
        $tipo_campos['entregada'] = 'checkbox';
        $tipo_campos['inicial'] = 'checkbox';
        $tipo_campos['validado'] = 'checkbox';
        $tipo_campos['pagado'] = 'checkbox';
        $tipo_campos['grava_isr'] = 'checkbox';
        $tipo_campos['recaptura'] = 'checkbox';
        $tipo_campos['redimencionado'] = 'checkbox';
        $tipo_campos['rentada'] = 'checkbox';
        $tipo_campos['revisar'] = 'checkbox';
        $tipo_campos['timbra'] = 'checkbox';
        $tipo_campos['timbrado'] = 'checkbox';


        foreach ($texts as $text){
            $tipo_campos[$text] = 'text';
        }

        $orden = 1;
        $elemento_lista_modelo = new elemento_lista($this->link);
        foreach($columnas as $columna){
            if(in_array($columna,$omite)){
                continue;
            }

            $etiqueta = str_replace('_',' ',$columna);
            if(array_key_exists($columna,$etiquetas)){
                $etiqueta = $etiquetas[$columna];
            }

            $data_columnas = '';
            if(array_key_exists($columna,$columnas_select)){
                $data_columnas = $columnas_select[$columna];
            }

            $tabla_externa = $this->registro['descripcion'];
            if(array_key_exists($columna,$externas)){
                $tabla_externa = $externas[$columna];
            }

            $campo_tabla_externa = $columna;
            if(array_key_exists($columna,$campos_tabla_externa)){
                $campo_tabla_externa = $campos_tabla_externa[$columna];
            }

            if(array_key_exists($columna,$ordenes)){
                $orden = $ordenes[$columna];
            }

            $elemento_lista_ins['columnas'] = $data_columnas;
            $elemento_lista_ins['descripcion'] = $this->registro['descripcion'].'_'.$columna;
            $elemento_lista_ins['status'] = 'activo';
            $elemento_lista_ins['seccion_id'] = $r_alta_bd->registro_id;
            $elemento_lista_ins['orden'] = $orden;
            $elemento_lista_ins['etiqueta'] = $etiqueta;

            $elemento_lista_ins['filtro'] = 'inactivo';
            if(in_array($columna,$filtro)){
                $elemento_lista_ins['filtro'] = 'activo';
            }

            $elemento_lista_ins['campo'] = $columna;
            $elemento_lista_ins['tabla_externa'] = $tabla_externa;
            $elemento_lista_ins['alta'] = 'activo';
            $elemento_lista_ins['modifica'] = 'activo';
            $elemento_lista_ins['tipo'] = $tipo_campos[$columna];
            $elemento_lista_ins['cols'] = 4;
            $elemento_lista_ins['requerido'] = 'inactivo';
            if(in_array($columna,$requerido)){
                $elemento_lista_ins['requerido'] = 'activo';
            }
            $elemento_lista_ins['con_label'] = 'inactivo';
            if(in_array($columna,$con_label)){
                $elemento_lista_ins['con_label'] = 'activo';
            }

            $elemento_lista_ins['lista'] = 'inactivo';
            if(in_array($columna,$lista)){
                $elemento_lista_ins['lista'] = 'activo';
            }


            $elemento_lista_ins['ln'] = 'inactivo';
            if(in_array($columna,$ln)){
                $elemento_lista_ins['ln'] = 'activo';
            }
            $elemento_lista_ins['encabezado'] = 'activo';
            $elemento_lista_ins['campo_tabla_externa'] = $campo_tabla_externa;
            $elemento_lista_ins['disabled'] = 'inactivo';
            $elemento_lista_ins['select_vacio_alta'] = 'inactivo';
            $elemento_lista_ins['modificador_palabra'] = 0;

            $elemento_lista_modelo->registro = $elemento_lista_ins;
            $r_elemento_lista = $elemento_lista_modelo->alta_bd();
            if(errores::$error){
                return $this->error->error(mensaje: 'Error al dar de alta elemento lista',data: $r_elemento_lista, params: get_defined_vars());
            }
            $orden++;
        }

        return $r_alta_bd;
    }

    /**
     *
     * @param int $menu_id
     * @return array
     */
    public function obten_submenu_permitido(int $menu_id): array
    { //FIN PROT
        $valida = $this->validacion->valida_estructura_menu($menu_id);
        if(errores::$error){
            return $this->error->error('Error al validar ',$valida);
        }

	    $grupo_id = $_SESSION['grupo_id'];

	    $where_menu = " AND seccion.menu_id = $menu_id";

	    $consulta = "SELECT 
               		seccion.id AS id ,
                		seccion.icono AS icono,
                		seccion.descripcion AS descripcion,
                		seccion.etiqueta_label AS etiqueta_label,
                		seccion.menu_id AS menu_id
                		FROM seccion
                	INNER JOIN accion  ON accion.seccion_id = seccion.id
                	INNER JOIN accion_grupo AS permiso ON permiso.accion_id = accion.id
                	INNER JOIN grupo  ON grupo.id = permiso.grupo_id
                	INNER JOIN menu  ON menu.id = seccion.menu_id
                WHERE 
                	seccion.status = 'activo' 
                	AND accion.status = 'activo' 
                	AND grupo.status = 'activo' 
                	AND permiso.grupo_id = $grupo_id $where_menu
                        AND accion.visible = 'activo'
                GROUP BY seccion.id
                ";
	    $result = $this->link->query($consulta);
	    $n_registros = $result->rowCount();

	    if($this->link->errorInfo()[1]){
	        return $this->error->error('Error al ejecutar sql',array($this->link->errorInfo(),$consulta));
	    }

	    $new_array = array();
	    while( $row = $result->fetchObject()){
	        $new_array[] = (array)$row;
	    }
        $result->closeCursor();
	    return array('registros' => $new_array, 'n_registros' => $n_registros);
	}
}